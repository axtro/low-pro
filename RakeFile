require 'rake'
require 'rubygems'
require 'zip/zip'
require 'fileutils'

def file_list(dir, *files)
  files.collect { |f| dir + "/#{f}" }
end

ROOT = File.dirname(__FILE__)
SRC = ROOT + '/src'
DIST = ROOT + '/dist'
TEST = ROOT + '/test'
DOC = ROOT + '/doc'

SOURCE_LIST = file_list SRC, 'lowpro.js', 'domready.js', 'eventext.js', 'behavior.js', 'selector.js'

DIST_LIST = file_list DIST, 'lowpro.js', 'lowpro.packed.js', 'README'

task :default => :dist

desc 'Package Low Pro for distribution.'
task :dist => :pack do
  puts 'Packaging distribution...'
  FileUtils.cp Dir[DOC + '/**/*'], DIST
  
  Zip::ZipFile.open(DIST + '/lowpro.zip', Zip::ZipFile::CREATE) do |zip|
    DIST_LIST.each do |f|
      zip.get_output_stream(File.basename(f)) { |o| o << File.open(f).read } if File.exists? f
    end
  end
  
end

desc 'Delete all files from dist.'
task :clean do
  puts 'Cleaning dist...'
  FileUtils.rm Dir[DIST + '/**/*']
end

desc 'Compiles JS into a single file.'
task :build => :clean do
  puts 'Building script...'
  File.open(DIST + '/lowpro.js', 'w') do |lowpro|
    SOURCE_LIST.each do |src|
      File.open(src) do |f| 
        lowpro << f.read
        lowpro << "\n\n"
      end
    end
  end
end

desc 'Uses packer to compact the build js file.'
task :pack => :build do
  puts 'Building packed version...'
  `~/scripts/jspack -i #{DIST + '/lowpro.js'} -o #{DIST + '/lowpro.packed.js'} -e62`
  orig, packed = File.size(DIST + '/lowpro.js'), File.size(DIST + '/lowpro.packed.js')
  puts "Original: #{orig} / Packed: #{packed} (#{((packed.to_f / orig.to_f) * 100).to_i}%)"
end

desc 'Copies a built version of LowPro to test dir.'
task :dist_to_test => :pack do
  FileUtils.cp [DIST + '/lowpro.js', DIST + '/lowpro.packed.js'], TEST
end
